<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HR Report - {{ district_name }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        padding: 40px;
        background: white;
      }

      .report-header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 3px solid #116753;
      }

      .report-header h1 {
        font-family: "Space Grotesk", sans-serif;
        color: #116753;
        font-size: 32px;
        margin-bottom: 10px;
      }

      .report-header h2 {
        color: #666;
        font-size: 24px;
        margin-bottom: 10px;
      }

      .report-header .actions {
        margin-top: 20px;
      }

      .btn {
        background: #116753;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin: 0 5px;
      }

      .btn:hover {
        background: #0d4f3f;
      }

      .metric-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin: 30px 0;
      }

      .metric-card {
        border: 2px solid #89bef4;
        padding: 20px;
        text-align: center;
        border-radius: 8px;
      }

      .metric-value {
        font-size: 36px;
        font-weight: 700;
        color: #02223c;
        font-family: "Space Grotesk", sans-serif;
        background: #89bef4;
        padding: 8px 16px;
        border-radius: 20px;
        display: inline-block;
      }

      .metric-label {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
      }

      .section {
        margin: 40px 0;
        page-break-inside: avoid;
      }

      .section h3 {
        font-family: "Space Grotesk", sans-serif;
        color: #02223c;
        margin-bottom: 20px;
        font-size: 22px;
      }

      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }

      canvas {
        max-width: 600px;
        margin: 0 auto;
        display: block;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border: 1px solid #ddd;
      }

      th {
        background: #116753;
        color: white;
        font-weight: 600;
      }

      tr:nth-child(even) {
        background: #f9f9f9;
      }

      .job-card {
        background: #f8f9fa;
        border-left: 4px solid #89bef4;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
        page-break-inside: avoid;
        text-align: left;
      }

      .job-card.excellent {
        border-left-color: #116753;
        background: #f0fdf4;
      }

      .job-card.poor {
        border-left-color: #ef4444;
        background: #fef2f2;
      }

      .quality-score {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 14px;
      }
      .metric-value.quality-score {
        font-size: 36px !important;
      }

      .score-excellent {
        background: #e8f0ca;
        color: #116753;
      }
      .score-good {
        background: #89bef4;
        color: #02223c;
      }
      .score-fair {
        background: #fed46b;
        color: #02223c;
      }
      .score-poor {
        background: #fee2e2;
        color: #991b1b;
      }

      .loading {
        text-align: center;
        padding: 60px;
        color: #666;
      }

      .spinner {
        border: 3px solid #e8f0ca;
        border-top: 3px solid #116753;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media print {
        .actions {
          display: none !important;
        }
        body {
          padding: 20px;
        }
        .section {
          page-break-inside: avoid;
        }
      }
    </style>
  </head>
  <body>
    <div class="report-header">
      <h1>üìä HR Administrator Report</h1>
      <h2 id="districtName">{{ district_name }}</h2>
      <div class="actions">
        <button class="btn" onclick="window.print()">
          üñ®Ô∏è Print / Save as PDF
        </button>
        <button class="btn" onclick="window.close()">‚úï Close</button>
      </div>
    </div>

    <div id="reportContent" class="loading">
      <div class="spinner"></div>
      <p>Loading report data...</p>
    </div>

    <script>
      const districtName = "{{ district_name }}";
      let currentCategoryChart = null;
      let currentLocationChart = null;

      // Load report on page load
      window.onload = function () {
        loadReport();
      };

      async function loadReport() {
        try {
          const response = await fetch("/api/generate-hr-report", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ district_name: districtName }),
          });

          const result = await response.json();

          if (result.error) {
            document.getElementById("reportContent").innerHTML =
              `<div style="color: #991b1b; padding: 20px; text-align: center;">
                            <strong>Error:</strong> ${result.error}<br>
                            ${result.message || ""}
                        </div>`;
            return;
          }

          displayReport(result.report);
        } catch (error) {
          document.getElementById("reportContent").innerHTML =
            '<div style="color: #991b1b; padding: 20px; text-align: center;">Error loading report. Please try again.</div>';
        }
      }

      function displayReport(report) {
        const score = report.quality_report.overall_quality_score;
        let scoreClass = "score-poor";
        if (score >= 80) scoreClass = "score-excellent";
        else if (score >= 65) scoreClass = "score-good";
        else if (score >= 50) scoreClass = "score-fair";

        let html = `
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value">${report.total_jobs}</div>
                        <div class="metric-label">Total Open Jobs</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value quality-score ${scoreClass}">${score}</div>
                        <div class="metric-label">Overall Quality Score</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${Math.round(report.quality_report.avg_word_count)}</div>
                        <div class="metric-label">Average Word Count</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${report.analysis.total_categories}</div>
                        <div class="metric-label">Job Categories</div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Open Positions by Category</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart" width="600" height="400"></canvas>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Open Positions by Location</h3>
                    <div class="chart-container">
                        <canvas id="locationChart" width="600" height="400"></canvas>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Average Days Open by Category</h3>
                    ${generateDaysOpenTable(report.analysis.by_category)}
                </div>
                
                <div class="section">
                    <h3>Top Performing Job Postings</h3>
                    ${generateJobCards(report.quality_report.top_performing_jobs, "excellent")}
                </div>
                
                <div class="section">
                    <h3>Improvement Opportunities</h3>
                    ${generateJobCards(report.quality_report.improvement_opportunities, "poor")}
                </div>
            `;

        document.getElementById("reportContent").innerHTML = html;

        renderChart("categoryChart", report.charts.category_chart);
        renderChart("locationChart", report.charts.location_chart);
      }

      function generateDaysOpenTable(byCategory) {
        const sorted = Object.entries(byCategory).sort(
          (a, b) => b[1].avg_days_open - a[1].avg_days_open,
        );

        let html =
          '<table><thead><tr><th>Category</th><th style="text-align: center;">Count</th><th style="text-align: center;">Avg Days Open</th></tr></thead><tbody>';

        for (const [category, data] of sorted) {
          const style =
            data.avg_days_open > 60 ? "color: #ef4444; font-weight: 700;" : "";
          html += `<tr>
                    <td>${category}</td>
                    <td style="text-align: center;">${data.count}</td>
                    <td style="text-align: center; ${style}">${data.avg_days_open} days</td>
                </tr>`;
        }

        html += "</tbody></table>";
        return html;
      }

      function generateJobCards(jobs, type) {
        if (!jobs || jobs.length === 0) {
          return '<p style="color: #666; font-style: italic;">No jobs in this category.</p>';
        }

        return jobs
          .map((job) => {
            const scoreClass =
              job.quality_score >= 80
                ? "score-excellent"
                : job.quality_score >= 65
                  ? "score-good"
                  : job.quality_score >= 50
                    ? "score-fair"
                    : "score-poor";

            return `
            <div class="job-card ${type}">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="text-align: left;">
                        <strong style="font-size: 16px;">${job.title}</strong><br>
                        <span style="color: #666; font-size: 14px;">${job.school} ‚Ä¢ ${job.category}</span>
                    </div>
                    <span class="quality-score ${scoreClass}">${job.quality_score}</span>
                </div>
                ${
                  job.reasons
                    ? `<div style="margin-top: 10px; font-size: 13px; color: #666; text-align: left;">
                    ${job.reasons.map((r) => `‚Ä¢ ${r}`).join("<br>")}
                </div>`
                    : ""
                }
            </div>
        `;
          })
          .join("");
      }

      function renderChart(canvasId, chartData) {
        const ctx = document.getElementById(canvasId);
        new Chart(ctx, {
          type: "pie",
          data: {
            labels: chartData.labels,
            datasets: [
              {
                data: chartData.values,
                backgroundColor: chartData.colors,
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "right",
                labels: { font: { size: 12 } },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
